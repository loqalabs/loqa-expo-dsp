<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>5</storyId>
    <title>Create TypeScript API Scaffold with Types</title>
    <status>drafted</status>
    <generatedAt>2025-11-20</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/1-5-create-typescript-api-scaffold-with-types.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>developer</asA>
    <iWant>a complete TypeScript API structure</iWant>
    <soThat>I can implement DSP functions with full type safety</soThat>
    <tasks>
- Create LoqaAudioDspModule.ts
  - Import requireNativeModule from expo-modules-core
  - Export native module: requireNativeModule('LoqaAudioDsp')
  - Add TypeScript type annotations for native module
- Create types.ts with all DSP type definitions
  - Define FFTOptions interface with JSDoc
  - Define FFTResult interface with JSDoc
  - Define PitchDetectionOptions interface with JSDoc
  - Define PitchResult interface with JSDoc
  - Define FormantExtractionOptions interface with JSDoc
  - Define FormantsResult interface with JSDoc
  - Define SpectrumAnalysisOptions interface with JSDoc
  - Define SpectrumResult interface with JSDoc
  - Follow exact type definitions from Architecture document
- Create errors.ts with custom error classes
  - Create LoqaAudioDspError base class with code and details
  - Create ValidationError extending LoqaAudioDspError
  - Create NativeModuleError extending LoqaAudioDspError
  - Add JSDoc comments to all error classes
- Create validation.ts with function signatures
  - Add validateAudioBuffer function signature (implementation in Epic 2)
  - Add validateSampleRate function signature
  - Add validateFFTSize function signature
  - Add JSDoc comments describing validation rules
- Create utils.ts with logging utilities
  - Implement logDebug function with DEBUG flag check
  - Implement logWarning function
  - Add JSDoc comments
  - Use [LoqaAudioDsp] prefix for all logs
- Create index.ts placeholder
  - Add placeholder export structure (actual exports in Epic 2+)
  - Import and re-export types
  - Import and re-export errors
  - Prepare for future function exports
- Verify TypeScript compilation
  - Run TypeScript compiler (tsc)
  - Ensure strict mode is enabled
  - Verify no compilation errors
  - Check that .d.ts files are generated
    </tasks>
  </story>

  <acceptanceCriteria>
AC1: Given native modules are scaffolded, When I create TypeScript source files, Then the following files exist in src/: index.ts (main exports - currently empty placeholder exports), LoqaAudioDspModule.ts (native module imports using requireNativeModule), types.ts with complete type definitions for all DSP functions (FFTOptions/Result, PitchDetectionOptions/Result, FormantExtractionOptions/Result, SpectrumAnalysisOptions/Result), errors.ts with custom error classes (LoqaAudioDspError base, ValidationError, NativeModuleError), validation.ts with validation function signatures (to be implemented), utils.ts with logging utilities (logDebug, logWarning)

AC2: Given type definitions exist, When I review them, Then all types have JSDoc comments describing their purpose

AC3: Given TypeScript files are created, When I compile the project, Then TypeScript compiles without errors in strict mode
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document - TypeScript Type Definitions</title>
        <section>Data Architecture - TypeScript Type Definitions</section>
        <snippet>Complete type definitions for FFTOptions/Result, PitchDetectionOptions/Result, FormantExtractionOptions/Result, SpectrumAnalysisOptions/Result. Use Float32Array for audio buffers (Web Audio API standard). All functions return Promise&lt;Result&gt; for async operations.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document - Error Handling</title>
        <section>Error Handling Pattern</section>
        <snippet>Custom error classes: LoqaAudioDspError (base with code and details), ValidationError (extends base with VALIDATION_ERROR code), NativeModuleError (extends base with NATIVE_MODULE_ERROR code). All errors include actionable messages.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Document - Logging Strategy</title>
        <section>Logging Strategy</section>
        <snippet>Conditional logging with DEBUG mode (\_\_DEV\_\_ || process.env.LOQA_AUDIO_DSP_DEBUG). logDebug for development info (gated), logWarning for non-critical issues. Prefix all logs with [LoqaAudioDsp]. Never log in production unless error/warning.</snippet>
      </doc>
    </docs>
    <code>
      <!-- No existing code to reference - this story creates the TypeScript foundation -->
    </code>
    <dependencies>
      <javascript>
        <package name="expo-modules-core" version="*" type="peer" note="For requireNativeModule" />
        <package name="typescript" version="^5.3.0" type="dev" />
      </javascript>
    </dependencies>
  </artifacts>

  <constraints>
- Follow type definitions exactly as specified in Architecture document
- TypeScript strict mode must be enabled
- Use Float32Array for audio buffers (Web Audio API standard)
- All types must have JSDoc comments
- All error classes must extend LoqaAudioDspError
- Logging must be conditional (DEBUG flag)
- Depends on Story 1.4 (native modules must be scaffolded)
- All types align with native module signatures from Stories 1.3 and 1.4
  </constraints>

  <interfaces>
    <interface>
      <name>FFTOptions</name>
      <kind>TypeScript interface</kind>
      <signature>
export interface FFTOptions {
  fftSize?: number;
  windowType?: 'hanning' | 'hamming' | 'blackman' | 'none';
  includePhase?: boolean;
}
      </signature>
      <path>src/types.ts</path>
    </interface>
    <interface>
      <name>FFTResult</name>
      <kind>TypeScript interface</kind>
      <signature>
export interface FFTResult {
  magnitude: Float32Array;
  phase?: Float32Array;
  frequencies: Float32Array;
}
      </signature>
      <path>src/types.ts</path>
    </interface>
    <interface>
      <name>Error Classes</name>
      <kind>TypeScript classes</kind>
      <signature>
export class LoqaAudioDspError extends Error {
  constructor(message: string, public code: string, public details?: Record&lt;string, unknown&gt;)
}
export class ValidationError extends LoqaAudioDspError
export class NativeModuleError extends LoqaAudioDspError
      </signature>
      <path>src/errors.ts</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
TypeScript compilation must pass with strict mode. Verify .d.ts files are generated correctly. Check JSDoc comments appear in IDE autocomplete. Lint code with ESLint to ensure quality. Test that types match Architecture document specifications.
    </standards>
    <locations>
\_\_tests\_\/ (to be created in Story 1.6 for actual tests)
TypeScript compilation is the primary validation for this story
    </locations>
    <ideas>
- Verify all required files exist in src/ directory (AC1)
- Check all types have JSDoc comments (AC2)
- Run `tsc --noEmit` and verify no errors (AC3)
- Verify strict mode enabled in tsconfig.json (AC3)
- Check .d.ts files are generated correctly (AC3)
- Test IDE autocomplete shows JSDoc comments
- Verify error classes extend properly
- Test logDebug respects DEBUG flag
    </ideas>
  </tests>
</story-context>
