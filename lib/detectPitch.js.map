{"version":3,"file":"detectPitch.js","sourceRoot":"","sources":["../src/detectPitch.ts"],"names":[],"mappings":"AAAA,wDAAwD;AACxD,OAAO,kBAAkB,MAAM,sBAAsB,CAAC;AACtD,OAAO,EAAE,iBAAiB,EAAE,MAAM,UAAU,CAAC;AAE7C,OAAO,EAAE,QAAQ,EAAE,MAAM,SAAS,CAAC;AACnC,OAAO,EAAE,mBAAmB,EAAE,kBAAkB,EAAE,MAAM,cAAc,CAAC;AAEvE;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;GAgCG;AACH,MAAM,CAAC,KAAK,UAAU,WAAW,CAC/B,WAAoC,EACpC,UAAkB,EAClB,OAAwC;IAExC,gDAAgD;IAChD,QAAQ,CAAC,oBAAoB,EAAE;QAC7B,YAAY,EAAE,WAAW,CAAC,MAAM;QAChC,UAAU,EAAE,WAAW,YAAY,YAAY,CAAC,CAAC,CAAC,cAAc,CAAC,CAAC,CAAC,UAAU;QAC7E,UAAU;QACV,OAAO;KACR,CAAC,CAAC;IAEH,mBAAmB,CAAC,WAAW,CAAC,CAAC;IACjC,kBAAkB,CAAC,UAAU,CAAC,CAAC;IAE/B,2DAA2D;IAC3D,0CAA0C;IAC1C,MAAM,YAAY,GAAG,OAAO,EAAE,YAAY,IAAI,EAAE,CAAC;IACjD,MAAM,YAAY,GAAG,OAAO,EAAE,YAAY,IAAI,GAAG,CAAC;IAElD,2BAA2B;IAC3B,IAAI,YAAY,IAAI,CAAC,IAAI,YAAY,IAAI,CAAC,EAAE,CAAC;QAC3C,MAAM,IAAI,iBAAiB,CAAC,kCAAkC,EAAE;YAC9D,YAAY;YACZ,YAAY;SACb,CAAC,CAAC;IACL,CAAC;IAED,IAAI,YAAY,IAAI,YAAY,EAAE,CAAC;QACjC,MAAM,IAAI,iBAAiB,CAAC,6CAA6C,EAAE;YACzE,YAAY;YACZ,YAAY;SACb,CAAC,CAAC;IACL,CAAC;IAED,sDAAsD;IACtD,8DAA8D;IAC9D,MAAM,WAAW,GACf,WAAW,YAAY,YAAY,CAAC,CAAC,CAAC,KAAK,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC,CAAC,WAAW,CAAC;IAE9E,QAAQ,CAAC,2CAA2C,EAAE;QACpD,UAAU;QACV,YAAY;QACZ,YAAY;KACb,CAAC,CAAC;IAEH,IAAI,CAAC;QACH,6BAA6B;QAC7B,MAAM,YAAY,GAAG,MAAM,kBAAkB,CAAC,WAAW,CAAC,WAAW,EAAE,UAAU,EAAE;YACjF,YAAY;YACZ,YAAY;SACb,CAAC,CAAC;QAEH,QAAQ,CAAC,qCAAqC,EAAE;YAC9C,SAAS,EAAE,YAAY,CAAC,SAAS;YACjC,UAAU,EAAE,YAAY,CAAC,UAAU;YACnC,QAAQ,EAAE,YAAY,CAAC,QAAQ;SAChC,CAAC,CAAC;QAEH,6CAA6C;QAC7C,0EAA0E;QAC1E,MAAM,MAAM,GAAgB;YAC1B,SAAS,EAAE,YAAY,CAAC,SAAS,KAAK,IAAI,CAAC,CAAC,CAAC,YAAY,CAAC,SAAS,CAAC,CAAC,CAAC,IAAI;YAC1E,UAAU,EAAE,YAAY,CAAC,UAAU;YACnC,QAAQ,EAAE,YAAY,CAAC,QAAQ;SAChC,CAAC;QAEF,QAAQ,CAAC,oCAAoC,EAAE;YAC7C,SAAS,EAAE,MAAM,CAAC,SAAS;YAC3B,UAAU,EAAE,MAAM,CAAC,UAAU;YAC7B,QAAQ,EAAE,MAAM,CAAC,QAAQ;SAC1B,CAAC,CAAC;QAEH,OAAO,MAAM,CAAC;IAChB,CAAC;IAAC,OAAO,KAAc,EAAE,CAAC;QACxB,+DAA+D;QAC/D,MAAM,YAAY,GAAG,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC,CAAC;QAE5E,QAAQ,CAAC,oBAAoB,EAAE;YAC7B,KAAK,EAAE,YAAY;YACnB,UAAU;YACV,YAAY,EAAE,WAAW,CAAC,MAAM;SACjC,CAAC,CAAC;QAEH,MAAM,IAAI,iBAAiB,CAAC,2BAA2B,YAAY,EAAE,EAAE;YACrE,aAAa,EAAE,KAAK;YACpB,UAAU;YACV,YAAY;YACZ,YAAY;YACZ,YAAY,EAAE,WAAW,CAAC,MAAM;SACjC,CAAC,CAAC;IACL,CAAC;AACH,CAAC","sourcesContent":["// detectPitch - Pitch detection API using YIN algorithm\nimport LoqaAudioDspModule from './LoqaAudioDspModule';\nimport { NativeModuleError } from './errors';\nimport type { PitchDetectionOptions, PitchResult } from './types';\nimport { logDebug } from './utils';\nimport { validateAudioBuffer, validateSampleRate } from './validation';\n\n/**\n * Detects pitch using YIN algorithm\n *\n * This function performs fundamental frequency (F0) detection on audio data using\n * the YIN algorithm, which is optimized for voice and monophonic instruments.\n * It accepts audio buffers as Float32Array or number[], validates the input,\n * and returns pitch information with confidence scores.\n *\n * @param audioBuffer - Audio samples (Float32Array or number[])\n * @param sampleRate - Sample rate in Hz (8000-48000)\n * @param options - Pitch detection options (minFrequency, maxFrequency)\n * @returns Promise resolving to pitch result with frequency, confidence, and voicing\n * @throws ValidationError if buffer or sample rate are invalid\n * @throws NativeModuleError if native computation fails\n *\n * @example\n * ```typescript\n * const audioData = new Float32Array(2048);\n * // ... fill with audio samples ...\n *\n * const result = await detectPitch(audioData, 44100, {\n *   minFrequency: 80,   // Minimum detectable pitch (Hz)\n *   maxFrequency: 400   // Maximum detectable pitch (Hz)\n * });\n *\n * if (result.isVoiced) {\n *   console.log(`Detected pitch: ${result.frequency} Hz`);\n *   console.log(`Confidence: ${result.confidence}`);\n * } else {\n *   console.log('No pitch detected (unvoiced segment)');\n * }\n * ```\n */\nexport async function detectPitch(\n  audioBuffer: Float32Array | number[],\n  sampleRate: number,\n  options?: Partial<PitchDetectionOptions>\n): Promise<PitchResult> {\n  // Step 1: Validate audio buffer and sample rate\n  logDebug('detectPitch called', {\n    bufferLength: audioBuffer.length,\n    bufferType: audioBuffer instanceof Float32Array ? 'Float32Array' : 'number[]',\n    sampleRate,\n    options,\n  });\n\n  validateAudioBuffer(audioBuffer);\n  validateSampleRate(sampleRate);\n\n  // Step 2: Extract and set defaults for optional parameters\n  // Default to human voice range: 80-400 Hz\n  const minFrequency = options?.minFrequency ?? 80;\n  const maxFrequency = options?.maxFrequency ?? 400;\n\n  // Validate frequency range\n  if (minFrequency <= 0 || maxFrequency <= 0) {\n    throw new NativeModuleError('Frequency range must be positive', {\n      minFrequency,\n      maxFrequency,\n    });\n  }\n\n  if (minFrequency >= maxFrequency) {\n    throw new NativeModuleError('minFrequency must be less than maxFrequency', {\n      minFrequency,\n      maxFrequency,\n    });\n  }\n\n  // Step 3: Convert to number[] for React Native bridge\n  // React Native bridge requires plain arrays, not typed arrays\n  const bufferArray: number[] =\n    audioBuffer instanceof Float32Array ? Array.from(audioBuffer) : audioBuffer;\n\n  logDebug('Calling native module for pitch detection', {\n    sampleRate,\n    minFrequency,\n    maxFrequency,\n  });\n\n  try {\n    // Step 4: Call native module\n    const nativeResult = await LoqaAudioDspModule.detectPitch(bufferArray, sampleRate, {\n      minFrequency,\n      maxFrequency,\n    });\n\n    logDebug('Native module returned pitch result', {\n      frequency: nativeResult.frequency,\n      confidence: nativeResult.confidence,\n      isVoiced: nativeResult.isVoiced,\n    });\n\n    // Step 5: Convert result to PitchResult type\n    // Native module returns dictionary/map, convert to proper TypeScript type\n    const result: PitchResult = {\n      frequency: nativeResult.frequency !== null ? nativeResult.frequency : null,\n      confidence: nativeResult.confidence,\n      isVoiced: nativeResult.isVoiced,\n    };\n\n    logDebug('detectPitch completed successfully', {\n      frequency: result.frequency,\n      confidence: result.confidence,\n      isVoiced: result.isVoiced,\n    });\n\n    return result;\n  } catch (error: unknown) {\n    // Step 6: Wrap native errors in NativeModuleError with context\n    const errorMessage = error instanceof Error ? error.message : String(error);\n\n    logDebug('detectPitch failed', {\n      error: errorMessage,\n      sampleRate,\n      bufferLength: audioBuffer.length,\n    });\n\n    throw new NativeModuleError(`Pitch detection failed: ${errorMessage}`, {\n      originalError: error,\n      sampleRate,\n      minFrequency,\n      maxFrequency,\n      bufferLength: audioBuffer.length,\n    });\n  }\n}\n"]}